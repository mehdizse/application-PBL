---
import BaseLayout from '../layouts/BaseLayout.astro';
---

<BaseLayout>
  <!-- Auth Check will be done in JavaScript - HIDDEN by default -->
  <div id="auth-check" class="hidden">
    <!-- Hero Section -->
    <section class="relative overflow-hidden bg-gradient-to-r from-purple-600 to-pink-600 py-3">
      <div class="section-container relative z-10 flex items-center justify-between">
        <div>
          <h1 class="text-3xl font-bold text-white mb-1">üé® Espace Admin - Ajouter une Production</h1>
          <p class="text-sm text-purple-100">Publiez les √©critures et photos des √©l√®ves facilement</p>
        </div>
        <button id="logout-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded transition-colors">
          üö™ D√©connexion
        </button>
      </div>
    </section>

    <!-- Main Content -->
    <section class="section-container py-16">
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <!-- Main Form -->
        <div class="lg:col-span-2">
          <!-- Tabs for Format Selection -->
          <div class="flex space-x-4 mb-8 border-b-2 border-gray-200">
            <button class="format-tab active pb-4 px-6 border-b-4 border-purple-600 font-bold text-gray-900 transition-all duration-200" data-format="text">
              üìù Format √âcrit
            </button>
            <button class="format-tab pb-4 px-6 border-b-4 border-transparent font-bold text-gray-600 hover:text-gray-900 transition-all duration-200" data-format="photo">
              üì∏ Format Photo
            </button>
          </div>

          <!-- Form Section: Text Format -->
          <form id="text-form" class="format-content card p-8 mb-8">
            <h2 class="text-3xl font-bold text-gray-900 mb-6">üìù Ajouter un Article √âcrit</h2>

            <div class="mb-6">
              <label class="block text-sm font-bold text-gray-900 mb-2">Titre de la Production *</label>
              <input 
                type="text" 
                placeholder="Ex: Mon premier po√®me sur la nature"
                class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-purple-600 transition-colors duration-200"
                required
              >
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
              <div>
                <label class="block text-sm font-bold text-gray-900 mb-2">Nom de l'Auteur *</label>
                <input 
                  type="text" 
                  placeholder="Ex: Marie Dupont"
                  class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-purple-600 transition-colors duration-200"
                  required
                >
              </div>

              <div>
                <label class="block text-sm font-bold text-gray-900 mb-2">Classe/Niveau *</label>
                <select class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-purple-600 transition-colors duration-200" required>
                  <option value="">S√©lectionnez...</option>
                  <option value="cp">CP</option>
                  <option value="ce1">CE1</option>
                  <option value="ce2">CE2</option>
                  <option value="cm1">CM1</option>
                  <option value="cm2">CM2</option>
                  <option value="6e">6e</option>
                  <option value="5e">5e</option>
                  <option value="4e">4e</option>
                  <option value="3e">3e</option>
                </select>
              </div>
            </div>

            <div class="mb-6">
              <label class="block text-sm font-bold text-gray-900 mb-2">Nom du Projet *</label>
              <input 
                type="text" 
                placeholder="Ex: D√©couvrir la Po√©sie"
                class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-purple-600 transition-colors duration-200"
                required
              >
            </div>

            <div class="mb-6">
              <label class="block text-sm font-bold text-gray-900 mb-2">Description du Projet (Contexte) *</label>
              <textarea 
                rows="4"
                placeholder="Expliquez le contexte du projet et ses objectifs p√©dagogiques..."
                class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-purple-600 transition-colors duration-200"
                required
              ></textarea>
            </div>

            <div class="mb-6">
              <label class="block text-sm font-bold text-gray-900 mb-2">Contenu de la Production *</label>
              <textarea 
                rows="10"
                placeholder="Collez le texte de l'√©l√®ve ici..."
                class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-purple-600 transition-colors duration-200 font-mono text-sm"
                required
              ></textarea>
            </div>

            <div class="mb-6">
              <label class="block text-sm font-bold text-gray-900 mb-2">Tags (s√©par√©s par des virgules)</label>
              <input 
                type="text" 
                placeholder="Ex: po√©sie, nature, cr√©atif"
                class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-purple-600 transition-colors duration-200"
              >
            </div>

            <button 
              type="submit"
              class="w-full bg-gradient-to-r from-purple-500 to-pink-500 hover:from-purple-600 hover:to-pink-600 text-white font-bold py-3 rounded-lg transition-all duration-200 shadow-lg"
            >
              <span class="submit-text">üìù Publier l'Article √âcrit</span>
              <span class="submit-spinner hidden">‚è≥ Publication en cours...</span>
            </button>
          </form>

          <!-- Form Section: Photo Format -->
          <form id="photo-form" class="format-content hidden card p-8">
            <h2 class="text-3xl font-bold text-gray-900 mb-6">üì∏ Ajouter une Photo d'√âcrit</h2>

            <div class="mb-6">
              <label class="block text-sm font-bold text-gray-900 mb-2">Titre de la Production *</label>
              <input 
                type="text" 
                placeholder="Ex: Mon dessin et mon texte"
                class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-purple-600 transition-colors duration-200"
                required
              >
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
              <div>
                <label class="block text-sm font-bold text-gray-900 mb-2">Nom de l'Auteur *</label>
                <input 
                  type="text" 
                  placeholder="Ex: Jean Martin"
                  class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-purple-600 transition-colors duration-200"
                  required
                >
              </div>

              <div>
                <label class="block text-sm font-bold text-gray-900 mb-2">Classe/Niveau *</label>
                <select class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-purple-600 transition-colors duration-200" required>
                  <option value="">S√©lectionnez...</option>
                  <option value="cp">CP</option>
                  <option value="ce1">CE1</option>
                  <option value="ce2">CE2</option>
                  <option value="cm1">CM1</option>
                  <option value="cm2">CM2</option>
                  <option value="6e">6e</option>
                  <option value="5e">5e</option>
                  <option value="4e">4e</option>
                  <option value="3e">3e</option>
                </select>
              </div>
            </div>

            <div class="mb-6">
              <label class="block text-sm font-bold text-gray-900 mb-2">Nom du Projet *</label>
              <input 
                type="text" 
                placeholder="Ex: Illustrer une Histoire"
                class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-purple-600 transition-colors duration-200"
                required
              >
            </div>

            <div class="mb-6">
              <label class="block text-sm font-bold text-gray-900 mb-2">Description du Projet *</label>
              <textarea 
                rows="4"
                placeholder="Contexte et objectifs du projet..."
                class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-purple-600 transition-colors duration-200"
                required
              ></textarea>
            </div>

            <div class="mb-6">
              <label class="block text-sm font-bold text-gray-900 mb-2">Photo de la Production *</label>
              <div class="border-2 border-dashed border-purple-300 rounded-lg p-8 text-center hover:bg-purple-50 transition-colors duration-200 cursor-pointer" id="drag-drop-area">
                <input 
                  type="file" 
                  accept="image/*"
                  class="hidden"
                  id="photo-input"
                  required
                >
                <label for="photo-input" class="cursor-pointer">
                  <p class="text-4xl mb-2">üì∏</p>
                  <p class="text-gray-900 font-bold mb-1">Cliquez ou glissez votre photo</p>
                  <p class="text-gray-600 text-sm">Format: JPG, PNG (max 5MB)</p>
                </label>
              </div>
              <!-- Photo Preview -->
              <div id="photo-preview-container" class="hidden mt-4">
                <img id="photo-preview" src="" alt="Preview" class="w-full max-h-64 object-cover rounded-lg">
                <div class="mt-3 flex gap-2">
                  <button type="button" id="change-photo-btn" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded transition-colors">
                    üîÑ Changer la photo
                  </button>
                  <button type="button" id="remove-photo-btn" class="flex-1 bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded transition-colors">
                    ‚ùå Supprimer
                  </button>
                </div>
              </div>
            </div>

            <div class="mb-6">
              <label class="block text-sm font-bold text-gray-900 mb-2">Description de la Photo</label>
              <textarea 
                rows="4"
                placeholder="Expliquez ce qu'on voit sur la photo et le contexte..."
                class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-purple-600 transition-colors duration-200"
              ></textarea>
            </div>

            <div class="mb-6">
              <label class="block text-sm font-bold text-gray-900 mb-2">Tags</label>
              <input 
                type="text" 
                placeholder="Ex: dessin, histoire, cr√©atif"
                class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-purple-600 transition-colors duration-200"
              >
            </div>

            <button 
              type="submit"
              class="w-full bg-gradient-to-r from-purple-500 to-pink-500 hover:from-purple-600 hover:to-pink-600 text-white font-bold py-3 rounded-lg transition-all duration-200 shadow-lg"
            >
              <span class="submit-text">üì∏ Publier la Photo</span>
              <span class="submit-spinner hidden">‚è≥ Publication en cours...</span>
            </button>
          </form>
        </div>

        <!-- Sidebar -->
        <aside class="lg:col-span-1">
          <div class="card p-8 mb-8 bg-gradient-to-br from-purple-50 to-pink-50">
            <h3 class="text-2xl font-bold text-gray-900 mb-4">üìã Instructions</h3>
            <div class="space-y-4 text-sm text-gray-700">
              <div>
                <p class="font-bold text-purple-600 mb-1">‚úÖ Format √âcrit</p>
                <p>Collez directement le texte ou la production √©crite de l'√©l√®ve</p>
              </div>
              <div class="border-t border-gray-200 pt-4">
                <p class="font-bold text-purple-600 mb-1">‚úÖ Format Photo</p>
                <p>Uploadez une photo de la production (dessin + texte, travail manuels, etc.)</p>
              </div>
              <div class="border-t border-gray-200 pt-4">
                <p class="font-bold text-purple-600 mb-1">‚úÖ Informations Requises</p>
                <p>Titre, auteur, classe et contexte du projet</p>
              </div>
              <div class="border-t border-gray-200 pt-4">
                <p class="font-bold text-purple-600 mb-1">‚úÖ Utilit√© des Tags</p>
                <p>Cat√©gorisez pour une meilleure organisation</p>
              </div>
            </div>
          </div>

          <div class="card p-8 mb-8 border-2 border-purple-500">
            <h3 class="text-2xl font-bold text-gray-900 mb-4">üí° Conseils Utiles</h3>
            <ul class="space-y-3 text-sm text-gray-700">
              <li class="flex items-start space-x-2">
                <span class="text-purple-600 font-bold">‚Ä¢</span>
                <span>Obtenez l'accord des parents/tuteurs avant de publier</span>
              </li>
              <li class="flex items-start space-x-2">
                <span class="text-purple-600 font-bold">‚Ä¢</span>
                <span>Variez les types de productions (po√®mes, histoires, articles...)</span>
              </li>
              <li class="flex items-start space-x-2">
                <span class="text-purple-600 font-bold">‚Ä¢</span>
                <span>Partagez les photos au moins une fois par mois</span>
              </li>
              <li class="flex items-start space-x-2">
                <span class="text-purple-600 font-bold">‚Ä¢</span>
                <span>C√©l√©brez toutes les productions pour motiver les √©l√®ves</span>
              </li>
              <li class="flex items-start space-x-2">
                <span class="text-purple-600 font-bold">‚Ä¢</span>
                <span>Utilisez les meilleurs travaux pour inspirer d'autres √©l√®ves</span>
              </li>
            </ul>
          </div>

          <div class="card p-8 bg-gradient-to-br from-pink-500 to-purple-500 text-white">
            <h3 class="text-2xl font-bold mb-4">üåü Galerie Publique</h3>
            <p class="mb-6">Consultez tous les articles publi√©s et les meilleures productions</p>
            <a href="/gallery" class="inline-block bg-white text-purple-600 font-bold py-2 px-4 rounded-lg hover:bg-gray-100 transition-colors">
              üëÅÔ∏è Voir la Galerie
            </a>
          </div>
        </aside>
      </div>
    </section>
  </div>

  <!-- Not Authenticated - ALSO HIDDEN by default until auth check -->
  <div id="not-authenticated" class="hidden">
    <section class="section-container py-20">
      <div class="max-w-md mx-auto text-center">
        <div class="card p-8">
          <p class="text-4xl mb-4">üîê</p>
          <h2 class="text-3xl font-bold text-gray-900 mb-4">Acc√®s Restreint</h2>
          <p class="text-gray-700 mb-6">Vous devez √™tre connect√© pour acc√©der √† cet espace.</p>
          <a href="/login" class="inline-block bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg transition-colors">
            üîì Se Connecter
          </a>
        </div>
      </div>
    </section>
  </div>
</BaseLayout>

<script>
  import { auth, db } from '../lib/firebase.js';
  import { onAuthStateChanged, signOut } from 'firebase/auth';
  import { collection, addDoc, serverTimestamp } from 'firebase/firestore';

  const authCheck = document.getElementById('auth-check');
  const notAuthenticated = document.getElementById('not-authenticated');
  const logoutBtn = document.getElementById('logout-btn');

  onAuthStateChanged(auth, (user) => {
    if (user) {
      authCheck.classList.remove('hidden');
      notAuthenticated.classList.add('hidden');
      setupFormHandlers(user);
      setupTabSwitching();
      setupPhotoUpload();
    } else {
      authCheck.classList.add('hidden');
      notAuthenticated.classList.remove('hidden');
    }
  });

  function setupTabSwitching() {
    document.querySelectorAll('.format-tab').forEach(tab => {
      tab.addEventListener('click', () => {
        const format = tab.dataset.format;
        
        document.querySelectorAll('.format-tab').forEach(t => {
          t.classList.remove('active', 'border-purple-600', 'border-b-4');
          t.classList.add('border-transparent', 'text-gray-600');
        });
        tab.classList.add('active', 'border-purple-600', 'border-b-4', 'text-gray-900');
        
        document.querySelectorAll('.format-content').forEach(content => {
          content.classList.add('hidden');
        });
        document.getElementById(`${format}-form`).classList.remove('hidden');
      });
    });
  }

  function setupPhotoUpload() {
    const photoInput = document.getElementById('photo-input');
    const dragDropArea = document.getElementById('drag-drop-area');
    const photoPreviewContainer = document.getElementById('photo-preview-container');
    const photoPreview = document.getElementById('photo-preview');
    const changePhotoBtn = document.getElementById('change-photo-btn');
    const removePhotoBtn = document.getElementById('remove-photo-btn');
    
    // Show preview when photo is selected
    const showPhotoPreview = (file) => {
      if (file) {
        const reader = new FileReader();
        reader.onload = (e) => {
          photoPreview.src = e.target.result;
          photoPreviewContainer.classList.remove('hidden');
          dragDropArea.classList.add('hidden');
        };
        reader.readAsDataURL(file);
      }
    };

    photoInput.addEventListener('change', (e) => {
      if (e.target.files[0]) {
        showPhotoPreview(e.target.files[0]);
      }
    });

    changePhotoBtn.addEventListener('click', () => {
      photoInput.click();
    });

    removePhotoBtn.addEventListener('click', () => {
      photoInput.value = '';
      photoPreviewContainer.classList.add('hidden');
      dragDropArea.classList.remove('hidden');
    });
    
    if (dragDropArea) {
      dragDropArea.addEventListener('dragover', (e) => {
        e.preventDefault();
        dragDropArea.classList.add('bg-purple-50', 'border-purple-600');
      });
      
      dragDropArea.addEventListener('dragleave', () => {
        dragDropArea.classList.remove('bg-purple-50', 'border-purple-600');
      });
      
      dragDropArea.addEventListener('drop', (e) => {
        e.preventDefault();
        dragDropArea.classList.remove('bg-purple-50', 'border-purple-600');
        if (e.dataTransfer.files.length) {
          photoInput.files = e.dataTransfer.files;
          showPhotoPreview(e.dataTransfer.files[0]);
        }
      });
    }
  }

  function setupFormHandlers(user) {
    const textForm = document.getElementById('text-form');
    const photoForm = document.getElementById('photo-form');

    if (textForm) {
      textForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const submitBtn = textForm.querySelector('button[type="submit"]');
        const submitText = submitBtn.querySelector('.submit-text');
        const submitSpinner = submitBtn.querySelector('.submit-spinner');
        
        // Show loading state
        submitBtn.disabled = true;
        submitText.classList.add('hidden');
        submitSpinner.classList.remove('hidden');
        
        const inputs = textForm.querySelectorAll('input[type="text"]');
        const select = textForm.querySelector('select');
        const textareas = textForm.querySelectorAll('textarea');

        const title = inputs[0].value;
        const author = inputs[1].value;
        const level = select.value;
        const projectName = inputs[2].value;
        const description = textareas[0].value;
        const content = textareas[1].value;
        const tags = inputs[3].value.split(',').map(t => t.trim()).filter(t => t);

        try {
          await addDoc(collection(db, 'articles'), {
            title,
            author,
            level,
            projectName,
            description,
            content,
            format: '√©crit',
            tags,
            status: 'published',
            userId: user.uid,
            createdAt: serverTimestamp()
          });

          // Show success message
          alert('‚úÖ Article √©crit publi√© avec succ√®s!');
          textForm.reset();
          submitText.classList.remove('hidden');
          submitSpinner.classList.add('hidden');
          submitBtn.disabled = false;
        } catch (error) {
          alert(`‚ùå Erreur: ${error.message}`);
          submitText.classList.remove('hidden');
          submitSpinner.classList.add('hidden');
          submitBtn.disabled = false;
        }
      });
    }

    if (photoForm) {
      photoForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const submitBtn = photoForm.querySelector('button[type="submit"]');
        const submitText = submitBtn.querySelector('.submit-text');
        const submitSpinner = submitBtn.querySelector('.submit-spinner');
        
        // Show loading state
        submitBtn.disabled = true;
        submitText.classList.add('hidden');
        submitSpinner.classList.remove('hidden');
        
        const inputs = photoForm.querySelectorAll('input[type="text"]');
        const selects = photoForm.querySelectorAll('select');
        const textareas = photoForm.querySelectorAll('textarea');
        const photoInput = document.getElementById('photo-input');
        const photoFile = photoInput.files[0];

        if (!photoFile) {
          alert('‚ùå Veuillez s√©lectionner une photo');
          submitText.classList.remove('hidden');
          submitSpinner.classList.add('hidden');
          submitBtn.disabled = false;
          return;
        }

        const title = inputs[0].value;
        const author = inputs[1].value;
        const level = selects[0].value;
        const projectName = inputs[2].value;
        const description = textareas[0].value;
        const photoDescription = textareas[1].value;
        const tags = inputs[3].value.split(',').map(t => t.trim()).filter(t => t);

        try {
          // Convert photo to base64
          const reader = new FileReader();
          reader.onload = async (event) => {
            try {
              const photoBase64 = event.target.result;

              await addDoc(collection(db, 'articles'), {
                title,
                author,
                level,
                projectName,
                description,
                photoDescription,
                photoBase64, // Store as base64 instead of uploading to Storage
                format: 'photo',
                tags,
                status: 'published',
                userId: user.uid,
                createdAt: serverTimestamp()
              });

              alert('‚úÖ Photo publi√©e avec succ√®s!');
              photoForm.reset();
              document.getElementById('photo-preview-container').classList.add('hidden');
              document.getElementById('drag-drop-area').classList.remove('hidden');
              submitText.classList.remove('hidden');
              submitSpinner.classList.add('hidden');
              submitBtn.disabled = false;
            } catch (error) {
              alert(`‚ùå Erreur: ${error.message}`);
              submitText.classList.remove('hidden');
              submitSpinner.classList.add('hidden');
              submitBtn.disabled = false;
            }
          };
          reader.readAsDataURL(photoFile);
        } catch (error) {
          alert(`‚ùå Erreur: ${error.message}`);
          submitText.classList.remove('hidden');
          submitSpinner.classList.add('hidden');
          submitBtn.disabled = false;
        }
      });
    }
  }

  if (logoutBtn) {
    logoutBtn.addEventListener('click', async () => {
      await signOut(auth);
      window.location.href = '/login';
    });
  }
</script>
