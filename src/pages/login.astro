---
import BaseLayout from '../layouts/BaseLayout.astro';
---

<BaseLayout>
  <!-- Hero Section -->
  <section class="relative overflow-hidden bg-gradient-to-r from-blue-600 to-purple-600 py-2">
    <div class="section-container relative z-10">
      <h1 class="text-2xl font-bold text-white mb-0">üîê Connexion Enseignant</h1>
    </div>
  </section>

  <!-- Login Container -->
  <section class="section-container py-16">
    <div class="max-w-md mx-auto">
      <div class="card p-8">
        <!-- Login Form -->
        <form id="login-form" class="space-y-6">
          <h2 class="text-3xl font-bold text-center text-gray-900 mb-8">Se Connecter</h2>

          <!-- Email Input -->
          <div>
            <label class="block text-sm font-bold text-gray-900 mb-2">Email (enseignant) *</label>
            <input 
              type="email" 
              id="login-email"
              placeholder="votre.email@ecole.fr"
              class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-blue-600 transition-colors duration-200"
              required
            >
          </div>

          <!-- Password Input -->
          <div>
            <label class="block text-sm font-bold text-gray-900 mb-2">Mot de Passe *</label>
            <input 
              type="password" 
              id="login-password"
              placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
              class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-blue-600 transition-colors duration-200"
              required
            >
          </div>

          <!-- Error Message -->
          <div id="error-message" class="hidden p-4 bg-red-100 border-2 border-red-400 text-red-700 rounded-lg">
            <p id="error-text"></p>
          </div>

          <!-- Submit Button -->
          <button 
            type="submit"
            class="w-full bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-700 hover:to-purple-700 text-white font-bold py-3 rounded-lg transition-all duration-200 shadow-lg disabled:opacity-70 disabled:cursor-not-allowed"
            disabled={false}
          >
            <span class="flex items-center justify-center">
              <span class="btn-text">üîì Se Connecter</span>
              <span class="spinner hidden ml-2">
                <svg class="animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                  <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                  <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
              </span>
            </span>
          </button>
        </form>

        <!-- Sign Up Link -->
        <div class="mt-8 pt-8 border-t border-gray-300 text-center">
          <p class="text-gray-700 mb-4">Nouveau sur cette plateforme?</p>
          <button 
            type="button"
            id="toggle-signup"
            class="text-blue-600 hover:text-blue-700 font-bold"
          >
            Cr√©er un compte
          </button>
        </div>
      </div>

      <!-- Sign Up Form (Hidden by default) -->
      <div id="signup-form-container" class="hidden mt-8">
        <div class="card p-8">
          <form id="signup-form" class="space-y-6">
            <h2 class="text-3xl font-bold text-center text-gray-900 mb-8">Cr√©er un Compte</h2>

            <!-- Full Name Input -->
            <div>
              <label class="block text-sm font-bold text-gray-900 mb-2">Nom Complet *</label>
              <input 
                type="text" 
                id="signup-name"
                placeholder="Ex: Marie Dupont"
                class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-purple-600 transition-colors duration-200"
                required
              >
            </div>

            <!-- School Input -->
            <div>
              <label class="block text-sm font-bold text-gray-900 mb-2">√âcole *</label>
              <input 
                type="text" 
                id="signup-school"
                placeholder="Ex: √âcole Primaire Jean Jaur√®s"
                class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-purple-600 transition-colors duration-200"
                required
              >
            </div>

            <!-- Email Input -->
            <div>
              <label class="block text-sm font-bold text-gray-900 mb-2">Email *</label>
              <input 
                type="email" 
                id="signup-email"
                placeholder="votre.email@ecole.fr"
                class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-purple-600 transition-colors duration-200"
                required
              >
            </div>

            <!-- Password Input -->
            <div>
              <label class="block text-sm font-bold text-gray-900 mb-2">Mot de Passe *</label>
              <input 
                type="password" 
                id="signup-password"
                placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-purple-600 transition-colors duration-200"
                required
              >
              <p class="text-xs text-gray-600 mt-1">Minimum 6 caract√®res</p>
            </div>

            <!-- Confirm Password -->
            <div>
              <label class="block text-sm font-bold text-gray-900 mb-2">Confirmer le Mot de Passe *</label>
              <input 
                type="password" 
                id="signup-password-confirm"
                placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-purple-600 transition-colors duration-200"
                required
              >
            </div>

            <!-- Error Message -->
            <div id="signup-error-message" class="hidden p-4 bg-red-100 border-2 border-red-400 text-red-700 rounded-lg">
              <p id="signup-error-text"></p>
            </div>

            <!-- Submit Button -->
          <button 
            type="submit"
            class="w-full bg-gradient-to-r from-green-600 to-blue-600 hover:from-green-700 hover:to-blue-700 text-white font-bold py-3 rounded-lg transition-all duration-200 shadow-lg disabled:opacity-70 disabled:cursor-not-allowed"
            disabled={false}
          >
            <span class="flex items-center justify-center">
              <span class="btn-text">Cr√©er mon compte</span>
              <span class="spinner hidden ml-2">
                <svg class="animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                  <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                  <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
              </span>
            </span>
          </button>

            <!-- Back to Login -->
            <div class="text-center">
              <button 
                type="button"
                id="toggle-login"
                class="text-purple-600 hover:text-purple-700 font-bold"
              >
                Retour √† la connexion
              </button>
            </div>
          </form>
        </div>
      </div>

      <!-- Info Box -->
      <div class="mt-8 p-6 bg-blue-50 border-2 border-blue-200 rounded-lg">
        <h3 class="font-bold text-blue-900 mb-3">üìù Pour Commencer:</h3>
        <ol class="text-sm text-blue-800 space-y-2 list-decimal list-inside">
          <li>Cr√©ez un compte avec votre email professionnel</li>
          <li>Acc√©dez √† l'espace admin</li>
          <li>Ajoutez les productions de vos √©l√®ves</li>
          <li>Les articles seront publi√©s apr√®s v√©rification</li>
        </ol>
      </div>
    </div>
  </section>
</BaseLayout>

<!-- Import des modules Firebase dans une balise script s√©par√©e -->
<script>
  import { createUserWithEmailAndPassword, signInWithEmailAndPassword, updateProfile } from 'firebase/auth';
  import { auth } from '../lib/firebase.js';

  // Fonction pour afficher les erreurs
  function showError(elementId, message) {
    const element = document.getElementById(elementId);
    if (element) {
      element.textContent = message;
      element.parentElement.classList.remove('hidden');
    }
  }

  // Fonction pour masquer les erreurs
  function hideError(elementId) {
    const element = document.getElementById(elementId);
    if (element) {
      element.textContent = '';
      element.parentElement.classList.add('hidden');
    }
  }

  // Fonction pour basculer entre les formulaires
  function toggleForms(showSignup = false) {
    const loginContainer = document.getElementById('login-form')?.parentElement;
    const signupContainer = document.getElementById('signup-form-container');
    
    if (loginContainer && signupContainer) {
      if (showSignup) {
        loginContainer.classList.add('hidden');
        signupContainer.classList.remove('hidden');
        // Faire d√©filer vers le formulaire d'inscription
        signupContainer.scrollIntoView({ behavior: 'smooth' });
      } else {
        loginContainer.classList.remove('hidden');
        signupContainer.classList.add('hidden');
        // Faire d√©filer vers le haut de la page
        window.scrollTo({ top: 0, behavior: 'smooth' });
      }
    }
  }

  // Attendre que le DOM soit compl√®tement charg√©
  document.addEventListener('DOMContentLoaded', () => {
    console.log('DOM charg√©, initialisation du formulaire de connexion...');
    
    // √âl√©ments du DOM
    const loginForm = document.getElementById('login-form');
    const signupForm = document.getElementById('signup-form');
    const toggleSignupBtn = document.getElementById('toggle-signup');
    const toggleLoginBtn = document.getElementById('toggle-login');

    // Afficher les √©l√©ments trouv√©s dans la console pour le d√©bogage
    console.log('√âl√©ments du DOM:', {
      loginForm: !!loginForm,
      signupForm: !!signupForm,
      toggleSignupBtn: !!toggleSignupBtn,
      toggleLoginBtn: !!toggleLoginBtn
    });

    // Gestion du clic sur le bouton "Cr√©er un compte"
    if (toggleSignupBtn) {
      toggleSignupBtn.addEventListener('click', (e) => {
        e.preventDefault();
        console.log('Bouton "Cr√©er un compte" cliqu√©');
        toggleForms(true);
      });
    } else {
      console.error('Bouton "Cr√©er un compte" non trouv√©');
    }

    // Gestion du bouton de retour √† la connexion
    if (toggleLoginBtn) {
      toggleLoginBtn.addEventListener('click', (e) => {
        e.preventDefault();
        console.log('Bouton "Retour √† la connexion" cliqu√©');
        toggleForms(false);
      });
    } else {
      console.error('Bouton de retour √† la connexion non trouv√©');
    }

    // Gestion de la soumission du formulaire de connexion
    if (loginForm) {
      loginForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        console.log('Tentative de connexion...');
        
        const email = document.getElementById('login-email')?.value.trim();
        const password = document.getElementById('login-password')?.value;
        const submitBtn = loginForm.querySelector('button[type="submit"]');
        const submitText = submitBtn?.querySelector('.btn-text');
        const submitSpinner = submitBtn?.querySelector('.spinner');

        // V√©rifier les champs vides
        if (!email || !password) {
          showError('error-text', '‚ùå Veuillez remplir tous les champs obligatoires');
          return;
        }

        // Valider le format de l'email
        if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
          showError('error-text', '‚ùå Veuillez entrer une adresse email valide');
          return;
        }

        try {
          // Afficher l'indicateur de chargement
          if (submitBtn && submitText && submitSpinner) {
            submitBtn.disabled = true;
            submitText.classList.add('hidden');
            submitSpinner.classList.remove('hidden');
          }

          // Masquer les erreurs pr√©c√©dentes
          hideError('error-text');
          
          console.log('Tentative de connexion avec:', { email });
          
          // Tenter de se connecter
          const userCredential = await signInWithEmailAndPassword(auth, email, password);
          console.log('Utilisateur connect√©:', userCredential.user);
          
          // Rediriger vers la page admin apr√®s une connexion r√©ussie
          window.location.href = '/admin';
          
        } catch (error) {
          console.error('Erreur de connexion:', error);
          
          // Afficher un message d'erreur appropri√©
          let errorMessage = 'Une erreur est survenue lors de la connexion';
          
          if (error.code === 'auth/user-not-found') {
            errorMessage = '‚ùå Aucun compte trouv√© avec cet email.';
          } else if (error.code === 'auth/wrong-password') {
            errorMessage = '‚ùå Mot de passe incorrect.';
          } else if (error.code === 'auth/too-many-requests') {
            errorMessage = '‚ùå Trop de tentatives √©chou√©es. Veuillez r√©essayer plus tard.';
          } else if (error.code === 'auth/invalid-email') {
            errorMessage = '‚ùå Adresse email invalide.';
          } else if (error.code === 'auth/user-disabled') {
            errorMessage = '‚ùå Ce compte a √©t√© d√©sactiv√©.';
          }
          
          showError('error-text', errorMessage);
          
        } finally {
          // R√©activer le bouton et masquer l'indicateur de chargement
          if (submitBtn && submitText && submitSpinner) {
            submitBtn.disabled = false;
            submitText.classList.remove('hidden');
            submitSpinner.classList.add('hidden');
          }
        }
      });
    } else {
      console.error('loginForm non trouv√©');
    }

    // Gestion de la soumission du formulaire d'inscription
    if (signupForm) {
      signupForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        console.log('Tentative d\'inscription...');
        
        // R√©cup√©ration des valeurs des champs
        const name = document.getElementById('signup-name')?.value.trim();
        const school = document.getElementById('signup-school')?.value.trim();
        const email = document.getElementById('signup-email')?.value.trim();
        const password = document.getElementById('signup-password')?.value;
        const confirmPassword = document.getElementById('signup-password-confirm')?.value;
        
        const submitBtn = signupForm.querySelector('button[type="submit"]');
        const submitText = submitBtn?.querySelector('.btn-text');
        const submitSpinner = submitBtn?.querySelector('.spinner');

        // Validation des champs
        if (!name || !email || !password || !confirmPassword) {
          showError('signup-error-text', '‚ùå Tous les champs marqu√©s d\'un ast√©risque sont obligatoires');
          return;
        }

        // Validation du format de l'email
        if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
          showError('signup-error-text', '‚ùå Veuillez entrer une adresse email valide');
          return;
        }

        // V√©rification de la correspondance des mots de passe
        if (password !== confirmPassword) {
          showError('signup-error-text', '‚ùå Les mots de passe ne correspondent pas');
          return;
        }

        // V√©rification de la longueur du mot de passe
        if (password.length < 6) {
          showError('signup-error-text', '‚ùå Le mot de passe doit contenir au moins 6 caract√®res');
          return;
        }

        // V√©rification de la complexit√© du mot de passe
        if (!/(?=.*[a-z])(?=.*[A-Z])(?=.*\d)/.test(password)) {
          showError('signup-error-text', '‚ùå Le mot de passe doit contenir au moins une majuscule, une minuscule et un chiffre');
          return;
        }

        try {
          // Afficher l'indicateur de chargement
          if (submitBtn && submitText && submitSpinner) {
            submitBtn.disabled = true;
            submitText.classList.add('hidden');
            submitSpinner.classList.remove('hidden');
          }

          // Masquer les erreurs pr√©c√©dentes
          hideError('signup-error-text');
          
          console.log('Tentative de cr√©ation de compte avec:', { email, name });
          
          // Cr√©ation du compte utilisateur
          const userCredential = await createUserWithEmailAndPassword(auth, email, password);
          
          // Mise √† jour du profil avec le nom complet et l'√©cole
          await updateProfile(userCredential.user, {
            displayName: name,
            photoURL: school || ''
          });

          console.log('Compte cr√©√© avec succ√®s:', userCredential.user);
          
          // Afficher un message de succ√®s
          alert('‚úÖ Compte cr√©√© avec succ√®s ! Vous allez √™tre redirig√© vers l\'espace d\'administration.');
          
          // Rediriger vers la page admin
          window.location.href = '/admin';
          
        } catch (error) {
          console.error('Erreur lors de la cr√©ation du compte:', error);
          
          // Afficher un message d'erreur appropri√©
          let errorMessage = 'Une erreur est survenue lors de la cr√©ation du compte';
          
          if (error.code === 'auth/email-already-in-use') {
            errorMessage = '‚ùå Cette adresse email est d√©j√† utilis√©e par un autre compte.';
          } else if (error.code === 'auth/weak-password') {
            errorMessage = '‚ùå Le mot de passe est trop faible. Utilisez au moins 6 caract√®res avec des lettres et des chiffres.';
          } else if (error.code === 'auth/invalid-email') {
            errorMessage = '‚ùå L\'adresse email est invalide.';
          } else if (error.code === 'auth/operation-not-allowed') {
            errorMessage = '‚ùå La cr√©ation de compte est d√©sactiv√©e pour le moment.';
          }
          
          showError('signup-error-text', errorMessage);
          
        } finally {
          // R√©activer le bouton et masquer l'indicateur de chargement
          if (submitBtn && submitText && submitSpinner) {
            submitBtn.disabled = false;
            submitText.classList.remove('hidden');
            submitSpinner.classList.add('hidden');
          }
        }
      });
    } else {
      console.error('signupForm non trouv√©');
    }
  }); // Fin du DOMContentLoaded
</script>
