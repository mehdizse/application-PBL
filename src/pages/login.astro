---
import BaseLayout from '../layouts/BaseLayout.astro';
---

<BaseLayout>
  <!-- Hero Section -->
  <section class="relative overflow-hidden bg-gradient-to-r from-blue-600 to-purple-600 py-2">
    <div class="section-container relative z-10">
      <h1 class="text-2xl font-bold text-white mb-0">üîê Connexion Enseignant</h1>
    </div>
  </section>

  <!-- Login Container -->
  <section class="section-container py-16">
    <div class="max-w-md mx-auto">
      <div class="card p-8">
        <!-- Login Form -->
        <form id="login-form" class="space-y-6">
          <h2 class="text-3xl font-bold text-center text-gray-900 mb-8">Se Connecter</h2>

          <!-- Email Input -->
          <div>
            <label class="block text-sm font-bold text-gray-900 mb-2">Email (enseignant) *</label>
            <input 
              type="email" 
              id="login-email"
              placeholder="votre.email@ecole.fr"
              class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-blue-600 transition-colors duration-200"
              required
            >
          </div>

          <!-- Password Input -->
          <div>
            <label class="block text-sm font-bold text-gray-900 mb-2">Mot de Passe *</label>
            <input 
              type="password" 
              id="login-password"
              placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
              class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-blue-600 transition-colors duration-200"
              required
            >
          </div>

          <!-- Error Message -->
          <div id="error-message" class="hidden p-4 bg-red-100 border-2 border-red-400 text-red-700 rounded-lg">
            <p id="error-text"></p>
          </div>

          <!-- Submit Button -->
          <button 
            type="submit"
            class="w-full bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-700 hover:to-purple-700 text-white font-bold py-3 rounded-lg transition-all duration-200 shadow-lg"
          >
            üîì Se Connecter
          </button>
        </form>

        <!-- Sign Up Link -->
        <div class="mt-8 pt-8 border-t border-gray-300 text-center">
          <p class="text-gray-700 mb-4">Nouveau sur cette plateforme?</p>
          <button 
            type="button"
            id="toggle-signup"
            class="text-blue-600 hover:text-blue-700 font-bold"
          >
            Cr√©er un compte
          </button>
        </div>
      </div>

      <!-- Sign Up Form (Hidden by default) -->
      <div id="signup-form-container" class="hidden mt-8">
        <div class="card p-8">
          <form id="signup-form" class="space-y-6">
            <h2 class="text-3xl font-bold text-center text-gray-900 mb-8">Cr√©er un Compte</h2>

            <!-- Full Name Input -->
            <div>
              <label class="block text-sm font-bold text-gray-900 mb-2">Nom Complet *</label>
              <input 
                type="text" 
                id="signup-name"
                placeholder="Ex: Marie Dupont"
                class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-purple-600 transition-colors duration-200"
                required
              >
            </div>

            <!-- School Input -->
            <div>
              <label class="block text-sm font-bold text-gray-900 mb-2">√âcole *</label>
              <input 
                type="text" 
                id="signup-school"
                placeholder="Ex: √âcole Primaire Jean Jaur√®s"
                class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-purple-600 transition-colors duration-200"
                required
              >
            </div>

            <!-- Email Input -->
            <div>
              <label class="block text-sm font-bold text-gray-900 mb-2">Email *</label>
              <input 
                type="email" 
                id="signup-email"
                placeholder="votre.email@ecole.fr"
                class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-purple-600 transition-colors duration-200"
                required
              >
            </div>

            <!-- Password Input -->
            <div>
              <label class="block text-sm font-bold text-gray-900 mb-2">Mot de Passe *</label>
              <input 
                type="password" 
                id="signup-password"
                placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-purple-600 transition-colors duration-200"
                required
              >
              <p class="text-xs text-gray-600 mt-1">Minimum 6 caract√®res</p>
            </div>

            <!-- Confirm Password -->
            <div>
              <label class="block text-sm font-bold text-gray-900 mb-2">Confirmer le Mot de Passe *</label>
              <input 
                type="password" 
                id="signup-password-confirm"
                placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-purple-600 transition-colors duration-200"
                required
              >
            </div>

            <!-- Error Message -->
            <div id="signup-error-message" class="hidden p-4 bg-red-100 border-2 border-red-400 text-red-700 rounded-lg">
              <p id="signup-error-text"></p>
            </div>

            <!-- Submit Button -->
            <button 
              type="submit"
              class="w-full bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-700 hover:to-pink-700 text-white font-bold py-3 rounded-lg transition-all duration-200 shadow-lg"
            >
              ‚úÖ Cr√©er le Compte
            </button>

            <!-- Back to Login -->
            <div class="text-center">
              <button 
                type="button"
                id="toggle-login"
                class="text-purple-600 hover:text-purple-700 font-bold"
              >
                Retour √† la connexion
              </button>
            </div>
          </form>
        </div>
      </div>

      <!-- Info Box -->
      <div class="mt-8 p-6 bg-blue-50 border-2 border-blue-200 rounded-lg">
        <h3 class="font-bold text-blue-900 mb-3">üìù Pour Commencer:</h3>
        <ol class="text-sm text-blue-800 space-y-2 list-decimal list-inside">
          <li>Cr√©ez un compte avec votre email professionnel</li>
          <li>Acc√©dez √† l'espace admin</li>
          <li>Ajoutez les productions de vos √©l√®ves</li>
          <li>Les articles seront publi√©s apr√®s v√©rification</li>
        </ol>
      </div>
    </div>
  </section>
</BaseLayout>

<script>
  import { auth } from '../lib/firebase.js';
  import { createUserWithEmailAndPassword, signInWithEmailAndPassword, updateProfile } from 'firebase/auth';

  // Attendre que le DOM soit compl√®tement charg√©
  document.addEventListener('DOMContentLoaded', () => {
    console.log('DOM charg√©, recherche des √©l√©ments...');
    
    const loginForm = document.getElementById('login-form');
    const signupForm = document.getElementById('signup-form');
    const toggleSignupBtn = document.getElementById('toggle-signup');
    const toggleLoginBtn = document.getElementById('toggle-login');
    const signupContainer = document.getElementById('signup-form-container');
    const loginContainer = document.getElementById('login-form')?.parentElement;
    const errorMessage = document.getElementById('error-message');
    const signupErrorMessage = document.getElementById('signup-error-message');

    console.log('√âl√©ments trouv√©s:', {
      loginForm: !!loginForm,
      signupForm: !!signupForm,
      toggleSignupBtn: !!toggleSignupBtn,
      toggleLoginBtn: !!toggleLoginBtn,
      signupContainer: !!signupContainer,
      loginContainer: !!loginContainer,
      errorMessage: !!errorMessage,
      signupErrorMessage: !!signupErrorMessage
    });

    // Toggle between login and signup
    if (toggleSignupBtn) {
      toggleSignupBtn.addEventListener('click', (e) => {
        e.preventDefault();
        console.log('Bouton toggleSignupBtn cliqu√©');
        if (loginContainer) loginContainer.classList.add('hidden');
        if (signupContainer) signupContainer.classList.remove('hidden');
      });
    } else {
      console.error('toggleSignupBtn non trouv√©');
    }

    // Gestion du bouton de retour √† la connexion
    if (toggleLoginBtn) {
      toggleLoginBtn.addEventListener('click', (e) => {
        e.preventDefault();
        console.log('Bouton toggleLoginBtn cliqu√©');
        if (loginContainer) loginContainer.classList.remove('hidden');
        if (signupContainer) signupContainer.classList.add('hidden');
      });
    } else {
      console.error('toggleLoginBtn non trouv√©');
    }

    // Gestion de la soumission du formulaire de connexion
    if (loginForm) {
      loginForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        console.log('Tentative de connexion...');
        const email = document.getElementById('login-email')?.value;
        const password = document.getElementById('login-password')?.value;

        if (!email || !password) {
          console.error('Email ou mot de passe manquant');
          return;
        }

        try {
          console.log('Tentative de connexion avec:', { email });
          if (errorMessage) errorMessage.classList.add('hidden');
          
          const userCredential = await signInWithEmailAndPassword(auth, email, password);
          console.log('Utilisateur connect√©:', userCredential.user);
          // Rediriger vers la page admin
          window.location.href = '/admin';
        } catch (error) {
          console.error('Erreur de connexion:', error);
          if (errorMessage) {
            errorMessage.classList.remove('hidden');
            const errorText = document.getElementById('error-text');
            if (errorText) {
              if (error.code === 'auth/user-not-found') {
                errorText.textContent = '‚ùå Cet email n\'existe pas.';
              } else if (error.code === 'auth/wrong-password') {
                errorText.textContent = '‚ùå Mot de passe incorrect.';
              } else {
                errorText.textContent = `‚ùå Erreur: ${error.message}`;
              }
            }
          }
        }
      });
    } else {
      console.error('loginForm non trouv√©');
    }

    // Gestion de la soumission du formulaire d'inscription
    if (signupForm) {
      signupForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        console.log('Tentative d\'inscription...');
        
        const name = document.getElementById('signup-name')?.value;
        const school = document.getElementById('signup-school')?.value;
        const email = document.getElementById('signup-email')?.value;
        const password = document.getElementById('signup-password')?.value;
        const confirmPassword = document.getElementById('signup-password-confirm')?.value;

        // Validation
        if (!name || !email || !password || !confirmPassword) {
          console.error('Tous les champs sont obligatoires');
          return;
        }

        if (password !== confirmPassword) {
          console.error('Les mots de passe ne correspondent pas');
          if (signupErrorMessage) {
            signupErrorMessage.classList.remove('hidden');
            const errorText = document.getElementById('signup-error-text');
            if (errorText) errorText.textContent = '‚ùå Les mots de passe ne correspondent pas.';
          }
          return;
        }

        if (password.length < 6) {
          console.error('Le mot de passe est trop court');
          if (signupErrorMessage) {
            signupErrorMessage.classList.remove('hidden');
            const errorText = document.getElementById('signup-error-text');
            if (errorText) errorText.textContent = '‚ùå Le mot de passe doit contenir au moins 6 caract√®res.';
          }
          return;
        }

        try {
          console.log('Tentative de cr√©ation de compte avec:', { email, name });
          if (signupErrorMessage) signupErrorMessage.classList.add('hidden');
          
          const userCredential = await createUserWithEmailAndPassword(auth, email, password);
          
          // Mise √† jour du profil avec le nom
          await updateProfile(userCredential.user, {
            displayName: name
          });

          console.log('Compte cr√©√© avec succ√®s:', userCredential.user);
          alert('‚úÖ Compte cr√©√© avec succ√®s! Vous √™tes maintenant connect√©.');
          // Rediriger vers la page admin
          window.location.href = '/admin';
        } catch (error) {
          console.error('Erreur lors de la cr√©ation du compte:', error);
          if (signupErrorMessage) {
            signupErrorMessage.classList.remove('hidden');
            const errorText = document.getElementById('signup-error-text');
            if (errorText) {
              if (error.code === 'auth/email-already-in-use') {
                errorText.textContent = '‚ùå Cet email est d√©j√† utilis√©.';
              } else if (error.code === 'auth/weak-password') {
                errorText.textContent = '‚ùå Le mot de passe est trop faible.';
              } else if (error.code === 'auth/invalid-email') {
                errorText.textContent = '‚ùå L\'adresse email est invalide.';
              } else {
                errorText.textContent = `‚ùå Erreur: ${error.message}`;
              }
            }
          }
        }
      });
    } else {
      console.error('signupForm non trouv√©');
    }
  }); // Fin du DOMContentLoaded
</script>
